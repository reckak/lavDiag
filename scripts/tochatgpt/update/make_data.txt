#' @description
#' Internal generator for small mixed-type datasets (ordinal + continuous)
#' used in examples and unit tests. Not exported.
#' @keywords internal
#' @noRd
.make_data <- function(
    n        = 120,
    rho      = 0.30,
    load_o   = c(.40, .55, .70),
    load_c   = c(.70, .55, .40),
    n_cat    = 2,
    thr      = 0,
    groups   = FALSE,
    g_diff   = c(F1 = 0.0, F2 = 0.0),
    seed     = 2025
) {
  stopifnot(length(load_o) == 3L, length(load_c) == 3L)
  if (length(thr) != (n_cat - 1L)) stop("thr must have length n_cat - 1")

  set.seed(seed)

  # latens ~ N(0,1) with rho correlation
  Sig <- matrix(c(1, rho, rho, 1), 2, 2)
  L   <- chol(Sig)
  Z   <- matrix(stats::rnorm(n * 2L), n, 2L)
  Eta <- Z %*% L
  colnames(Eta) <- c("F1", "F2")

  # Optional 2-group design
  if (isTRUE(groups)) {
    g <- rep(1:2, length.out = n)
    Eta[g == 2, "F1"] <- Eta[g == 2, "F1"] + g_diff["F1"]
    Eta[g == 2, "F2"] <- Eta[g == 2, "F2"] + g_diff["F2"]
  } else {
    g <- NULL
  }

  # Ordinal indcators (F1): y* -> cut -> integer 1..n_cat
  make_ord <- function(lambda, eta, thr) {
    eps_sd <- sqrt(max(1 - lambda^2, 1e-6))
    ystar  <- lambda * eta + stats::rnorm(length(eta), sd = eps_sd)
    as.integer(cut(ystar, breaks = c(-Inf, thr, Inf), labels = FALSE))
  }
  o1 <- make_ord(load_o[1], Eta[, "F1"], thr)
  o2 <- make_ord(load_o[2], Eta[, "F1"], thr)
  o3 <- make_ord(load_o[3], Eta[, "F1"], thr)

  # Continous indicators (F2)
  make_cont <- function(lambda, eta) {
    eps_sd <- sqrt(max(1 - lambda^2, 1e-6))
    as.numeric(lambda * eta + stats::rnorm(length(eta), sd = eps_sd))
  }
  c1 <- make_cont(load_c[1], Eta[, "F2"])
  c2 <- make_cont(load_c[2], Eta[, "F2"])
  c3 <- make_cont(load_c[3], Eta[, "F2"])

  df <- data.frame(o1, o2, o3, c1, c2, c3)
  if (!is.null(g)) df$group <- factor(g)
  df
}
